<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Random Name Dev By SuperMink</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --primary-color:#1f2937;         /* slate-800 */
  --accent-color:#ef4444;          /* red-500 */
  --button-color:#ff5a1f;          /* modern orange */
  --background-color:#f3f4f6;      /* gray-100 */
  --slot-height:150px;
  --bg-image:none;
  --slot-text-color:#f9fafb;       /* gray-50 */
  --button-text-color:#ffffff;
  --slot-background-color:#111827; /* gray-900 */
  --container-max-width-vw:46.875vw;
  --slot-font-size-vw:2.34375vw;
  --button-font-size-vw:calc(var(--slot-font-size-vw)*0.7);
  --container-vertical-alignment:center;
  --container-opacity:0.5;
  
  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠ Opacity ‡πÄ‡∏õ‡πá‡∏ô 0 */
  --container-box-shadow:0 10px 30px rgba(0,0,0,.06);
  --container-border-radius:18px;
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:center;
  background-color:var(--background-color);
  font-family:'Prompt',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--primary-color);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  letter-spacing:.2px;
  transition:background-color .5s ease
}

/* **MODIFIED**: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô body ‡πÇ‡∏î‡∏¢‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
body {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}
/* **NEW**: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô textarea ‡πÅ‡∏•‡∏∞ input ‡πÑ‡∏î‡πâ */
textarea, input {
    user-select: text !important;
    -webkit-user-select: text !important;
    -moz-user-select: text !important;
    -ms-user-select: text !important;
}

.viewport{
  width:100vw;height:100vh;
  display:flex;flex-direction:column;
  align-items:var(--container-vertical-alignment);justify-content:center;
  background:var(--background-color) var(--bg-image) center/cover no-repeat;
  transition:background .5s ease;
  padding: 0 4vw; 
}

.container{
  background:rgba(255,255,255,var(--container-opacity)); 
  padding:2vw;
  /* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö */
  border-radius:var(--container-border-radius);
  width:100%; 
  max-width:var(--container-max-width-vw);
  min-width:250px; 
  text-align:center;
  /* ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏á‡∏≤ */
  box-shadow:var(--container-box-shadow);
}

.slot-container{
  height:7.8125vw;max-height:150px;overflow:hidden;border:none;border-radius:14px;
  margin-bottom:30px;background:var(--slot-background-color);position:relative
}
#slotRoll{transition:transform 3s cubic-bezier(.2,.8,.2,1);transform:translateY(0)}

.slot-item{
  display:flex;flex-direction:column;justify-content:center;align-items:center;
  height:7.8125vw;max-height:150px;
  color:var(--slot-text-color);
  white-space:normal;line-height:1.075;padding:0 16px;text-align:center
}
.slot-name{font-size:var(--slot-font-size-vw);font-weight:800}
.slot-company{font-size:calc(var(--slot-font-size-vw)*0.6);opacity:.96;margin-top:.2em;font-weight:500}

button{
  width:100%;padding:18px;border:none;border-radius:12px;
  font-size:1.08rem;font-weight:700;cursor:pointer;
  transition:transform .06s, box-shadow .2s, background-color .3s
}

#pickButton{
  width:33.33%;max-width:300px;margin:0 auto;display:block;
  font-size:var(--button-font-size-vw);font-weight:800;padding:.6vw 1vw;min-height:54px;
  background:var(--button-color);color:var(--button-text-color);
  box-shadow:0 8px 20px rgba(255,90,31,.25)
}
#pickButton:hover:not(:disabled){transform:translateY(-1px)}
#pickButton:active:not(:disabled){transform:translateY(0)}
button:disabled{cursor:not-allowed;color:#94a3b8}
#pickButton:disabled{background:#9aa0a6;color:#eceff1;opacity:1;box-shadow:none}
#pickButton.loading{cursor:progress}
#pickButton.loading .spinner-icon{display:inline-block;margin-right:.5rem;transform-origin:center;animation:spin 1s linear infinite}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

/* FAB */
.fab-stack{position:fixed;top:24px;right:24px;display:flex;flex-direction:column;gap:14px;z-index:1000}
.fab-stack.hidden{opacity:0;pointer-events:none}
.fab-stack .floating-button{
  width:60px;height:60px;border-radius:16px;
  color:#ffffff;
  font-size:24px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0;
  /* ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å: ‡∏õ‡∏£‡∏±‡∏ö line-height ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
  line-height:1.0; 
  border:none;
  box-shadow:0 10px 20px rgba(0,0,0,.18);transition:transform .06s,filter .2s
}
.fab-stack .floating-button:hover{transform:translateY(-1px);filter:saturate(1.1)}

/* **MODIFIED**: ‡∏õ‡∏£‡∏±‡∏ö font-size ‡∏Ç‡∏≠‡∏á Settings Icon ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• */
#settingsButton{background:#92CEA8; color:#ffffff; font-size:32px} 
#settingsButton:hover{filter:brightness(1.05)}
#listToggleButton{background:#A8D1E7; color:#ffffff;} 
#fullscreenButton{background:#AF9F8C; color:#ffffff; font-size:30px}
#forceLockButton{background:#FFBBDA; color:#ffffff; font-size:26px} 

/* Modal base */
.modal{position:fixed;z-index:2000;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.55)}
.modal-content{
  background:#ffffff;margin:auto;padding:26px;border:1px solid #e5e7eb;width:88%;max-width:640px;max-height:90vh;overflow-y:auto;
  border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.15);text-align:left
}
.close-button{color:#9ca3af;float:right;font-size:28px;font-weight:800}
.close-button:hover{color:#111827;cursor:pointer}

/* settings form */
.setting-group{margin-bottom:18px;padding:14px;border:1px dashed #e5e7eb;border-radius:12px;background:#fafafa}
.setting-group label{display:block;margin-bottom:6px;font-weight:700}
.setting-group input[type="text"],
.setting-group input[type="number"],
.setting-group input[type="color"]{
  width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff
}
.setting-group input[type="color"]{height:42px;max-width:72px;padding:0}
.color-settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:10px}

.alignment-controls{display:flex;gap:10px;margin-top:10px}
.alignment-controls button{
  flex:1 1 auto;margin:0;padding:10px;font-size:1rem;border-radius:10px;background:#3b82f6;color:#fff
}
.alignment-controls button.active{background:#10b981}

/* Gallery */
#thumbnailGallery{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;border:1px solid #e5e7eb;padding:10px;border-radius:12px;max-height:220px;overflow:auto;position:relative;background:#fff}
#thumbnailGallery.dragover{outline:2px dashed #8b5cf6;outline-offset:4px}
.thumbnail-item{position:relative;width:86px;height:48px;overflow:hidden;border:3px solid transparent;border-radius:10px;cursor:grab;transition:border-color .2s,transform .06s,box-shadow .2s;box-shadow:0 4px 10px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;background:#fff}
.thumbnail-item.active{border-color:#ff5a1f;box-shadow:0 0 0 3px rgba(255,90,31,.22)}
.thumbnail-item img{width:100%;height:100%;object-fit:cover;display:block;pointer-events:none}
.thumbnail-number,.current-badge{
  position:absolute;background:rgba(0,0,0,.6);color:#fff;font-size:10px;padding:2px 6px;border-radius:999px;font-weight:700
}
.thumbnail-number{top:4px;left:4px}
.current-badge{bottom:4px;right:4px}
.thumbnail-delete-button{position:absolute;top:0;right:0;width:16px;height:16px;background:#ef4444;color:#fff;border:none;border-radius:0 6px 0 6px;font-size:11px;line-height:16px;text-align:center;padding:0;margin:0;cursor:pointer;opacity:0;transition:opacity .2s}
.thumbnail-item:hover .thumbnail-delete-button{opacity:1}
.drag-handle{position:absolute;bottom:3px;left:3px;background:rgba(0,0,0,.55);color:#fff;font-size:11px;line-height:1;padding:2px 4px;border-radius:4px;user-select:none}
/* **FIXED**: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô z-index ‡πÄ‡∏õ‡πá‡∏ô 9999 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏†‡∏≤‡∏û Ghost ‡∏•‡∏≠‡∏¢‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô */
.dragging-ghost{position:fixed;z-index:9999;pointer-events:none;opacity:.95;transform:scale(1.02);box-shadow:0 12px 28px rgba(0,0,0,.25);border-radius:8px;overflow:hidden}
.thumb-placeholder{width:86px;height:48px;border:2px dashed var(--accent-color);border-radius:8px}
.insert-line{position:absolute;width:2px;background:var(--accent-color);top:0;bottom:0;z-index:2500;pointer-events:none}
.gallery-meta{margin-top:6px;font-size:.92rem;color:#6b7280}
.note{color:#6b7280;font-size:.9rem}

/* List modal sizing parity */
#listModal .modal-content{max-width:640px}
#listModal textarea#nameList{width:100%;min-height:220px;font:inherit;border-radius:12px;padding:12px;border:1px solid #e5e7eb}
#listModal #historyPanel{width:100%}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô setting ‡πÉ‡∏ô List Modal */
#listModal .setting-icon {
  margin-left: 8px; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç */
  font-size: 1.2em;
  color: #94a3b8; /* ‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô */
  cursor: pointer;
  transition: color 0.2s;
  vertical-align: middle;
}
#listModal .setting-icon:hover {
  color: var(--primary-color);
}


@media (max-width:600px){
  .fab-stack{ top:12px; right:12px; gap:10px }
  .fab-stack .floating-button{ width:52px; height:52px; font-size:20px; border-radius:14px }
  :root{--slot-font-size-vw:2rem;--button-font-size-vw:1.35rem}
  .color-settings-grid{grid-template-columns:1fr}
}

@media (prefers-reduced-motion: reduce){
  #slotRoll{transition-duration:.01ms!important}
  *{scroll-behavior:auto!important}
}
</style>
</head>
<body oncontextmenu="return false">
<div class="viewport" id="viewport" tabindex="0">
  <div class="container">
    <div class="slot-container"><div id="slotRoll"></div></div>
    <button id="pickButton">DRAW</button>
  </div>

  <div id="fabStack" class="fab-stack" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏•‡∏≠‡∏¢">
    <button id="settingsButton" class="floating-button" title="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (S)" aria-label="‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤">‚öôÔ∏è</button>
    <button id="listToggleButton" class="floating-button" title="‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠/‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (L)" aria-label="‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">üë§</button>
    <button id="forceLockButton" class="floating-button" title="Force Lock (F)" aria-label="Force Lock">‚ù§Ô∏è</button>
    <button id="fullscreenButton" class="floating-button" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠" aria-label="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">‚õ∂</button>
  </div>

  <div id="listModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <span class="close-button" data-close="list" role="button" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">&times;</span>
      <h3 style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
      <button id="resetListButton" style="background:#10b981;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:800;margin-top:0;margin-bottom:16px">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
      
      <label style="display:inline-block;margin-top:4px;font-weight:700">
          ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà: <span id="nameCountDisplay">0</span>
          <span class="setting-icon" id="listSettingIcon" title="‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" role="button">‚öôÔ∏è</span>
      </label>
      <textarea id="nameList" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠ | ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)...">‡∏ä‡∏∑‡πà‡∏≠ A | ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó A
‡∏ä‡∏∑‡πà‡∏≠ B | ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó B
‡∏ä‡∏∑‡πà‡∏≠ C | ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó C
‡∏ä‡∏∑‡πà‡∏≠ D | ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó D</textarea>
      <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
        <label style="display:flex;align-items:center;gap:8px;font-weight:600">
          <input type="checkbox" id="allowRepeats"> ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥
        </label>
        <button id="showHistoryButton" style="background:#8b5cf6;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏° (<span id="historyCount">0</span>)</button>
      </div>
      <div id="historyPanel" style="display:none;margin-top:10px;border-top:1px solid #e5e7eb;padding-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏°</strong>
          <button id="clearHistoryButton" style="background:#f59e0b;color:#fff;border:none;border-radius:10px;padding:8px 12px;font-weight:700">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
        </div>
        <ol id="historyList" style="margin-top:8px;max-height:160px;overflow:auto"></ol>
      </div>
    </div>
  </div>

  <div id="settingsModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <span class="close-button" data-close="settings" role="button" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤">&times;</span>
      <h2 style="margin-top:0">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°</h2>

      <div class="setting-group">
        <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°</label>
        <div class="alignment-controls" id="alignmentControls">
          <button data-align="flex-start" id="alignLeft">Left</button>
          <button data-align="center" id="alignCenter">Center</button>
          <button data-align="flex-end" id="alignRight">Right</button>
        </div>
      </div>
      
      <div class="setting-group">
        <label for="containerOpacityInput">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å (0.0 - 1.0)</label>
        <div style="display:flex;align-items:center;margin-top:5px;gap:10px;">
          <input type="range" id="containerOpacitySlider" value="0.5" min="0.0" max="1.0" step="0.05" style="width:70%;padding:0;height:40px;">
          <input type="number" id="containerOpacityInput" value="0.5" min="0.0" max="1.0" step="0.05" style="width:88px;text-align:center;padding:10px;border-radius:10px">
        </div>
      </div>
      
      <div class="setting-group">
        <label for="spinDurationInput">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô (1-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
        <div style="display:flex;align-items:center;margin-top:5px;">
          <input type="number" id="spinDurationInput" value="3" min="1" max="10" style="width:88px;text-align:center;padding:10px;border-radius:10px">
          <span style="margin-left:10px;">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
        </div>
        <small class="note">*‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà, ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô = ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</small>
      </div>

      <div class="setting-group">
        <label>‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (size : 1920x1080)</label>
        <input type="file" id="bgImageFile" accept="image/*" style="display:none" multiple>
        <button id="uploadBgButton" style="background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
        <button id="clearBgImage" style="background:#6b7280;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)</button>
        <small class="note">*‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 15 ‡∏†‡∏≤‡∏û, ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° x/‡∏õ ‡πÅ‡∏•‡∏∞ z/‡∏ú ‡∏™‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á, ‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</small>
        <label style="display:block;margin:14px 0 6px;font-weight:700;">‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
        <div id="thumbnailGallery"><p style="color:#9ca3af;text-align:center;width:100%;margin:10px 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p></div>
        <div class="gallery-meta" id="galleryMeta">‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 0 / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 0</div>
        <small class="note">*‡∏•‡∏≤‡∏Å‚Äì‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏Å‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ</small>
      </div>

      <div class="color-settings-grid">
        <div class="setting-group color-group">
          <label for="slotBackgroundColor">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
          <input type="color" id="slotBackgroundColor" value="#111827">
          <span id="slotBackgroundColorDisplay">#111827</span>
        </div>
        <div class="setting-group color-group">
          <label for="slotTextColor">‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</label>
          <input type="color" id="slotTextColor" value="#f9fafb">
          <span id="slotTextColorDisplay">#F9FAFB</span>
        </div>
        <div class="setting-group color-group">
          <label for="buttonColor">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏° DRAW</label>
          <input type="color" id="buttonColor" value="#ff5a1f">
          <span id="buttonColorDisplay">#FF5A1F</span>
        </div>
        <div class="setting-group color-group">
          <label for="buttonTextColor">‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏° DRAW</label>
          <input type="color" id="buttonTextColor" value="#ffffff">
          <span id="buttonTextColorDisplay">#FFFFFF</span>
        </div>
      </div>

      <div class="setting-group">
        <label for="bgColor">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
        <input type="color" id="bgColor" value="#f3f4f6">
        <span id="bgColorDisplay">#F3F4F6</span>
      </div>

      <div class="setting-group" style="border:none;padding:0;">
        <button id="saveSettingsButton" style="background:#10b981;color:#fff;border:none;border-radius:12px;padding:14px 16px;font-weight:800;margin-top:8px;margin-bottom:6px">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Save)</button>
        <button id="clearAllSettingsButton" style="background:#94a3b8;color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset ‡πÄ‡∏õ‡πá‡∏ô Default)</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== Refs / State ====== */
const viewport=document.getElementById('viewport');
const slotRoll=document.getElementById('slotRoll');
const nameListTextarea=document.getElementById('nameList');
const pickButton=document.getElementById('pickButton');
const resetButton=document.getElementById('resetListButton');
const settingsButton=document.getElementById('settingsButton');
const listToggleButton=document.getElementById('listToggleButton');
const fullscreenButton=document.getElementById('fullscreenButton');
const forceLockButton=document.getElementById('forceLockButton');
const fabStack=document.getElementById('fabStack');

const listModal=document.getElementById('listModal');
const settingsModal=document.getElementById('settingsModal');

const nameCountDisplay=document.getElementById('nameCountDisplay');
const listSettingIcon=document.getElementById('listSettingIcon'); 

const bgColorInput=document.getElementById('bgColor');
const bgColorDisplay=document.getElementById('bgColorDisplay');
const buttonColorInput=document.getElementById('buttonColor');
const buttonColorDisplay=document.getElementById('buttonColorDisplay');
const spinDurationInput=document.getElementById('spinDurationInput');
const slotTextColorInput=document.getElementById('slotTextColor');
const slotTextColorDisplay=document.getElementById('slotTextColorDisplay');
const buttonTextColorInput=document.getElementById('buttonTextColor');
const buttonTextColorDisplay=document.getElementById('buttonTextColorDisplay');
const slotBackgroundColorInput=document.getElementById('slotBackgroundColor');
const slotBackgroundColorDisplay=document.getElementById('slotBackgroundColorDisplay');
const saveSettingsButton=document.getElementById('saveSettingsButton');
const clearAllSettingsButton=document.getElementById('clearAllSettingsButton');
const alignmentControls=document.getElementById('alignmentControls');
const bgImageFileInput=document.getElementById('bgImageFile');
const uploadBgButton=document.getElementById('uploadBgButton');
const clearBgImageButton=document.getElementById('clearBgImage');
const thumbnailGallery=document.getElementById('thumbnailGallery');
const galleryMeta=document.getElementById('galleryMeta');
const allowRepeatsCheckbox=document.getElementById('allowRepeats');
const showHistoryButton=document.getElementById('showHistoryButton');
const historyPanel=document.getElementById('historyPanel');
const historyList=document.getElementById('historyList');
const clearHistoryButton=document.getElementById('clearHistoryButton');
const historyCount=document.getElementById('historyCount');

const containerOpacitySlider=document.getElementById('containerOpacitySlider');
const containerOpacityInput=document.getElementById('containerOpacityInput');
let containerOpacity=0.5;


/* ===== Force Lock state ===== */
let lockedMap = new Map();
let lockedQueue = [];
function getLockedResultsText(){ return localStorage.getItem('pickerLockedResults') || ''; }
function isForceLockEnabled(){ return localStorage.getItem('pickerForceLockMode') === '1'; }

/* ===== Names ===== */
let backgroundImages=[]; let currentBgIndex=-1; const MAX_BG_IMAGES=15;
let names=[];
const BASE_SPEED_ITEMS_PER_SEC=5; let spinTimeInSeconds=3; let currentSpinDurationMS=spinTimeInSeconds*1000;
let allowRepeats=false; let winnerHistory=[];
let initialNameSnapshot='';

let lastPageDownTime = 0;
const DOUBLE_CLICK_TIME_MS = 400;

/* ===== Helpers ===== */
function parseEntry(line){
  const t=line.trim(); if(!t) return null;
  let person='', company=''; const seps=['|','-','\t',','];
  for(const s of seps){ if(t.includes(s)){ const [a,...rest]=t.split(s); person=a.trim(); company=rest.join(s).trim(); break; } }
  if(!person){ person=t; company=''; }
  return { raw:t, person, company };
}

/* ===== Locked Results Parsing ===== */
function parseLockedResults(){
  lockedMap.clear(); lockedQueue = [];
  const raw = getLockedResultsText().split('\n').map(l=>l.trim()).filter(Boolean);
  raw.forEach(line=>{
    const parts = line.split('|').map(p=>p.trim());
    const nameKey = parts[0] || '';
    const prize = parts.slice(1).join(' | ') || '';
    if(nameKey){ lockedMap.set(nameKey, prize); lockedQueue.push({name:nameKey, prize}); }
  });
}
function applyForceLockSettings(text, enabled){
  localStorage.setItem('pickerLockedResults', text || '');
  localStorage.setItem('pickerForceLockMode', enabled ? '1' : '0');
  parseLockedResults(); viewport.focus();
}
window.applyForceLockSettings = applyForceLockSettings;

/* ===== Slot DOM ===== */
function parseNameList(updateDisplay=true){
  names = nameListTextarea.value.split('\n').map(parseEntry).filter(Boolean).map(n=>({...n}));
  nameCountDisplay.textContent=names.length;
  localStorage.setItem('pickerNameList', nameListTextarea.value);
  pickButton.disabled=names.length===0;
  resetButton.disabled = (initialNameSnapshot.trim().length === 0);
  if(updateDisplay) updateSlotRoll(null, 15);
}
function makeSlotItem(entry){
  const el=document.createElement('div'); el.className='slot-item';
  const top=document.createElement('div'); top.className='slot-name'; top.textContent = entry?.person ?? entry ?? '';
  const bottom=document.createElement('div'); bottom.className='slot-company';
  if(entry?.prize){ bottom.textContent = entry.prize + (entry.company ? (' ‚Äî '+entry.company) : ''); bottom.style.opacity = '.98'; }
  else{ bottom.textContent = entry?.company ?? ''; if(!bottom.textContent) bottom.style.visibility='hidden'; }
  el.append(top,bottom); return el;
}
// **MODIFIED**: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå forceWelcome ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
function updateSlotRoll(winningEntry=null, itemsBeforeWinner=15, forceWelcome=false){
  slotRoll.innerHTML=''; const frag=document.createDocumentFragment();
  const pool = names.length ? names : [{person:'...‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤...',company:''}];
  
  // MODIFIED: Check if it's the first run (no winner, roll content is empty) ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á
  if (forceWelcome || (!winningEntry && slotRoll.innerHTML === '')) {
    // MODIFIED: Initial text before the first roll, removed the company text.
    frag.appendChild(makeSlotItem({person:'Ready to Win a Prize?', company:''}));
  } else {
    for(let i=0;i<itemsBeforeWinner;i++){ const t=pool[Math.floor(Math.random()*pool.length)]; frag.appendChild(makeSlotItem(t)); }
    frag.appendChild(makeSlotItem(winningEntry || pool[0]));
    for(let i=0;i<itemsBeforeWinner;i++){ const t=pool[Math.floor(Math.random()*pool.length)]; frag.appendChild(makeSlotItem(t)); }
  }
  
  slotRoll.appendChild(frag);
  slotRoll.style.transition='none'; slotRoll.style.transform='translateY(0)'; void slotRoll.offsetWidth;
}

/* ===== Pick logic ===== */
function findLockedMatchInNames(){
  for(const item of lockedQueue){
    const found = names.find(n => n.person === item.name || n.raw === item.name);
    if(found) return {mapEntry: item, nameEntry: found};
  }
  for(const item of lockedQueue){
    const found = names.find(n => n.person.toLowerCase() === item.name.toLowerCase() || n.raw.toLowerCase() === item.name.toLowerCase());
    if(found) return {mapEntry: item, nameEntry: found};
  }
  return null;
}
async function spinSlot(){
  if(names.length===0){
    slotRoll.style.transition='none'; slotRoll.style.transform='translateY(0)';
    updateSlotRoll({person:'‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚ùå',company:''}); return;
  }
  const forceMode = isForceLockEnabled(); parseLockedResults();

  const originalText=pickButton.textContent;
  pickButton.disabled=true; pickButton.classList.add('loading');
  pickButton.innerHTML='<span class="spinner-icon">‚ü≥</span> Spinning...';

  let winnerEntry = null;
  if(forceMode){
    const found = findLockedMatchInNames();
    if(found){
      winnerEntry = {...found.nameEntry};
      const winnerPrize = found.mapEntry.prize || null;
      if(winnerPrize) winnerEntry.prize = winnerPrize;
      const idx = lockedQueue.findIndex(it => it.name === found.mapEntry.name && it.prize === found.mapEntry.prize);
      if(idx !== -1) lockedQueue.splice(idx,1);
    }
  }
  if(!winnerEntry){
    const winnerIndex=Math.floor(Math.random()*names.length);
    winnerEntry = {...names[winnerIndex]};
    const possiblePrize = lockedMap.get(winnerEntry.person) || lockedMap.get(winnerEntry.raw) || null;
    if(possiblePrize) winnerEntry.prize = possiblePrize;
  }

  const dynamicRollItems=Math.max(5, Math.round(BASE_SPEED_ITEMS_PER_SEC*spinTimeInSeconds));
  updateSlotRoll(winnerEntry, dynamicRollItems);

  const targetIndex=dynamicRollItems;
  const firstSlotItem=slotRoll.querySelector('.slot-item');
  const responsiveSlotHeight=firstSlotItem?firstSlotItem.clientHeight:150;
  const targetPosition=targetIndex*responsiveSlotHeight;

  slotRoll.style.transition=`transform ${currentSpinDurationMS/1000}s cubic-bezier(0.2,0.8,0.2,1)`;
  slotRoll.style.transform=`translateY(-${targetPosition}px)`;
  await new Promise(r=>setTimeout(r, currentSpinDurationMS));

  const displayName = `${winnerEntry.person}${winnerEntry.company?(' ‚Äî '+winnerEntry.company):''}`;
  const historyItem = {name: displayName + (winnerEntry.prize ? (' ‚Äî '+winnerEntry.prize) : ''), time:new Date().toISOString()};
  winnerHistory.push(historyItem);
  localStorage.setItem('pickerWinnerHistory', JSON.stringify(winnerHistory));
  renderHistory();

  if(!allowRepeats){
    const removeIndex=names.findIndex(n=>n.raw===winnerEntry.raw && n.person===winnerEntry.person);
    if(removeIndex>-1) names.splice(removeIndex,1);
    nameListTextarea.value=names.map(n=>n.raw).join('\n');
    parseNameList(false);
  }else{
    nameCountDisplay.textContent=names.length;
  }

  pickButton.classList.remove('loading'); pickButton.textContent=originalText;
  if(names.length===0 && !allowRepeats){
    slotRoll.style.transition='none'; slotRoll.style.transform='translateY(0)';
    updateSlotRoll({person:'‚úÖ ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚úÖ',company:''});
  }else{
    pickButton.disabled=false;
  }
}

/* ===== Fullscreen ===== */
function isBrowserFullscreen(){const tol=2;const fsH=Math.abs(window.innerHeight - screen.height) < tol;const fsW=Math.abs(window.innerWidth  - screen.width)  < tol;return fsH && fsW;}
function toggleFloatingButtons(hide){fabStack?.classList.toggle('hidden', !!hide);} 
function syncFullscreenUI(){const apiFs=!!document.fullscreenElement;const browserFs=isBrowserFullscreen();const hide = apiFs || browserFs;toggleFloatingButtons(hide);fullscreenButton.textContent = hide ? '‚õû' : '‚õ∂';}
document.addEventListener('fullscreenchange', syncFullscreenUI); window.addEventListener('resize', syncFullscreenUI);

/* ===== Backgrounds ===== */
function applyBackgroundImage(){thumbnailGallery.querySelectorAll('.thumbnail-item').forEach(i=>i.classList.remove('active'));if(currentBgIndex>=0 && currentBgIndex<backgroundImages.length){document.documentElement.style.setProperty('--bg-image', `url('${backgroundImages[currentBgIndex]}')`);}else{document.documentElement.style.setProperty('--bg-image','none');}renderThumbnailGallery(); updateGalleryMeta();}
function nextBackgroundImage(){ if(!backgroundImages.length){currentBgIndex=-1;applyBackgroundImage();return;} currentBgIndex=(currentBgIndex+1)%backgroundImages.length; applyBackgroundImage();}
function prevBackgroundImage(){ if(!backgroundImages.length){currentBgIndex=-1;applyBackgroundImage();return;} currentBgIndex=(currentBgIndex-1+backgroundImages.length)%backgroundImages.length; applyBackgroundImage();}
function clearBackgroundImage(){ if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß? (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏ß‡∏£)')) return; currentBgIndex=-1; document.documentElement.style.setProperty('--bg-image','none'); backgroundImages=[]; renderThumbnailGallery(); updateGalleryMeta(); alert('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏ô‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏ß‡∏£');}
function deleteBackgroundImage(indexToDelete){ if(!confirm(`‡∏•‡∏ö‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${indexToDelete+1}? (‡∏Å‡∏î Save ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏ß‡∏£)`)) return; const activeContent=(currentBgIndex>=0&&currentBgIndex<backgroundImages.length)?backgroundImages[currentBgIndex]:null; backgroundImages.splice(indexToDelete,1); if(!backgroundImages.length){currentBgIndex=-1;} else if(activeContent){const newIdx=backgroundImages.indexOf(activeContent); currentBgIndex = (newIdx===-1)? Math.min(indexToDelete, backgroundImages.length-1) : newIdx;} else currentBgIndex=-1; applyBackgroundImage();}
function renderThumbnailGallery(){
  thumbnailGallery.innerHTML=''; 
  if(!backgroundImages.length){
    thumbnailGallery.innerHTML='<p style="color:#9ca3af;text-align:center;width:100%;margin:10px 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>'; 
    updateGalleryMeta(); 
    return;
  } 
  
  backgroundImages.forEach((dataUrl,index)=>{
    const item=document.createElement('div'); 
    item.className='thumbnail-item'; 
    item.dataset.index=String(index); 
    if(index===currentBgIndex) item.classList.add('active'); 
    
    const img=document.createElement('img'); 
    img.src=dataUrl; 
    img.alt=`Background ${index+1}`; 
    img.draggable="false"; 
    
    const num=document.createElement('span'); 
    num.className='thumbnail-number'; 
    num.textContent=index+1; 
    
    const del=document.createElement('button'); 
    del.className='thumbnail-delete-button'; 
    del.textContent='x'; 
    del.title='‡∏•‡∏ö‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ'; 
    
    const handle=document.createElement('span'); 
    handle.className='drag-handle'; 
    handle.textContent='‚ãÆ‚ãÆ'; 
    
    if(index===currentBgIndex){ 
      const badge=document.createElement('span'); 
      badge.className='current-badge'; 
      badge.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ'; 
      item.appendChild(badge); 
    }
    
    // **FIXED**: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Event ‡∏≠‡∏∑‡πà‡∏ô‡∏Ç‡∏≠‡∏á .thumbnail-item
    del.addEventListener('click', (e) => {
        e.stopPropagation(); // ‡∏´‡∏¢‡∏∏‡∏î Event ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏¢‡∏±‡∏á item ‡πÅ‡∏°‡πà
        deleteBackgroundImage(index);
    });

    item.addEventListener('click',e=>{ 
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏Å‡∏ö‡∏≤‡∏ó (‡∏ã‡∏∂‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å stopPropagation ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
      if((e.target).classList?.contains('thumbnail-delete-button')) return; 
      currentBgIndex=index; 
      applyBackgroundImage();
    });
    
    const startEl=(ev)=> startDrag(ev,item,index);
    // ‡πÉ‡∏ä‡πâ pointerdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (Drag Handle)
    handle.addEventListener('pointerdown', startEl, {passive:false});
    // ‡πÉ‡∏ä‡πâ pointerdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (Click ‡∏ö‡∏ô item)
    item.addEventListener('pointerdown', startEl, {passive:false});
    
    item.append(img,num,del,handle);
    thumbnailGallery.appendChild(item);
  });
  const activeItem=thumbnailGallery.querySelector('.thumbnail-item.active');
  activeItem?.scrollIntoView({behavior:'smooth',block:'nearest',inline:'nearest'});
}
function updateGalleryMeta(){const total=backgroundImages.length; const pos=(currentBgIndex>=0? currentBgIndex+1 : 0); galleryMeta.textContent=`‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${pos} / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total}`;}
let dragging=null, placeholder=null, insertLine=null;
function startDrag(ev,item,index){
  // **FIXED**: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå
  if(ev.target.classList.contains('thumbnail-delete-button')) return; // ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° drag ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö

  if(dragging?.ghost) dragging.ghost.remove();
  
  if(ev.isPrimary===false) return; 
  ev.preventDefault(); // **FIXED**: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Drag default ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
  
  const rect=item.getBoundingClientRect(); 
  dragging={el:item,index,offsetX:ev.clientX-rect.left,offsetY:ev.clientY-rect.top,width:rect.width,height:rect.height}; 
  const ghost=item.cloneNode(true); 
  ghost.classList.add('dragging-ghost'); 
  ghost.style.width=rect.width+'px'; 
  ghost.style.height=rect.height+'px'; 
  ghost.style.left=rect.left+'px'; 
  ghost.style.top=rect.top+'px'; 
  document.body.appendChild(ghost); 
  dragging.ghost=ghost; 
  
  placeholder=document.createElement('div'); 
  placeholder.className='thumb-placeholder'; 
  placeholder.style.width=rect.width+'px'; 
  placeholder.style.height=rect.height+'px'; 
  item.replaceWith(placeholder); 
  
  insertLine=document.createElement('div'); 
  insertLine.className='insert-line'; 
  thumbnailGallery.appendChild(insertLine); 
  
  window.addEventListener('pointermove', onDragMove, {passive:false}); 
  window.addEventListener('pointerup', onDragEnd, {once:true});
}
function onDragMove(ev){if(!dragging) return; ev.preventDefault(); const x=ev.clientX-dragging.offsetX, y=ev.clientY-dragging.offsetY; dragging.ghost.style.left=x+'px'; dragging.ghost.style.top=y+'px'; const idx=computeInsertionIndex(ev.clientX, ev.clientY); placePlaceholder(idx);} 
function onDragEnd(){if(!dragging) return; const children=Array.from(thumbnailGallery.children).filter(n=>n!==insertLine); const newIndex=children.indexOf(placeholder); const [moved]=backgroundImages.splice(dragging.index,1); const finalIndex=Math.max(0, Math.min(newIndex, backgroundImages.length)); backgroundImages.splice(finalIndex,0,moved); if(currentBgIndex>-1){ const content=moved; currentBgIndex=backgroundImages.indexOf(content); } dragging.ghost.remove(); placeholder.replaceWith(dragging.el); insertLine.remove(); dragging=null; placeholder=null; insertLine=null; renderThumbnailGallery(); applyBackgroundImage();}
function computeInsertionIndex(x,y){const items=[...thumbnailGallery.querySelectorAll('.thumbnail-item,.thumb-placeholder')]; if(!items.length) return 0; let closestIdx=items.length,closestDist=Infinity; items.forEach((el,idx)=>{const r=el.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; const d=Math.hypot(cx-x, cy-y); if(d<closestDist){closestDist=d; closestIdx=idx;}}); return closestIdx;}
function placePlaceholder(idx){if(!placeholder) return; const items=[...thumbnailGallery.querySelectorAll('.thumbnail-item,.thumb-placeholder')]; if(idx>=items.length) thumbnailGallery.appendChild(placeholder); else thumbnailGallery.insertBefore(placeholder, items[idx]);}

/* Drag & Drop images */
thumbnailGallery.addEventListener('dragover', e=>{ e.preventDefault(); thumbnailGallery.classList.add('dragover'); });
thumbnailGallery.addEventListener('dragleave', ()=> thumbnailGallery.classList.remove('dragover'));
thumbnailGallery.addEventListener('drop', async e=>{
  e.preventDefault(); thumbnailGallery.classList.remove('dragover');
  const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
  if(files.length===0) return;
  const space=MAX_BG_IMAGES-backgroundImages.length;
  const toProcess=files.slice(0, space);
  if(toProcess.length<files.length) alert(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${space} ‡∏†‡∏≤‡∏û`);
  const read=(file)=>new Promise(res=>{const r=new FileReader(); r.onload=ev=>res(ev.target.result); r.readAsDataURL(file);});
  try{
    const urls=await Promise.all(toProcess.map(read));
    backgroundImages.push(...urls);
    currentBgIndex=backgroundImages.length-1; applyBackgroundImage();
    alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ${urls.length} ‡∏†‡∏≤‡∏û (‡∏£‡∏ß‡∏° ${backgroundImages.length}/${MAX_BG_IMAGES}) ‚Äî ‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏ß‡∏£`); 
  }catch(err){ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå'); }
});

/* ===== Save / Load / History / Events ===== */
function saveSettings(){
  const st=getComputedStyle(document.documentElement);
  localStorage.setItem('pickerBgColor', st.getPropertyValue('--background-color').trim());
  localStorage.setItem('pickerButtonColor', st.getPropertyValue('--button-color').trim());
  localStorage.setItem('pickerSlotTextColor', st.getPropertyValue('--slot-text-color').trim());
  localStorage.setItem('pickerButtonTextColor', st.getPropertyValue('--button-text-color').trim());
  localStorage.setItem('pickerSlotBgColor', st.getPropertyValue('--slot-background-color').trim());
  localStorage.setItem('pickerSpinDuration', spinTimeInSeconds);
  localStorage.setItem('pickerBgImageIndex', currentBgIndex);
  localStorage.setItem('pickerBgImages', JSON.stringify(backgroundImages));
  localStorage.setItem('pickerNameList', nameListTextarea.value);
  localStorage.setItem('pickerAllowRepeats', allowRepeats ? '1' : '0');
  localStorage.setItem('pickerWinnerHistory', JSON.stringify(winnerHistory));
  localStorage.setItem('pickerContainerOpacity', containerOpacity);
  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
  settingsModal.style.display='none'; viewport.focus();
}
function clearAllSettings(){
  if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  ['pickerBgColor','pickerButtonColor','pickerSlotTextColor','pickerButtonTextColor','pickerSlotBgColor','pickerBgImages','pickerBgImageIndex','pickerSpinDuration','pickerVerticalAlignment','pickerNameList','pickerAllowRepeats','pickerWinnerHistory','pickerLockedResults','pickerForceLockMode', 'pickerContainerOpacity'].forEach(k=>localStorage.removeItem(k));
  alert('‚òëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà'); window.location.reload();
}
function renderHistory(){
  historyList.innerHTML='';
  if(!winnerHistory.length){ historyList.innerHTML='<li style="color:#6b7280">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>'; }
  else{
    winnerHistory.slice().reverse().forEach(item=>{
      const li=document.createElement('li');
      const dt=new Date(item.time);
      li.textContent=`${item.name} ‚Äî ${dt.toLocaleString()}`;
      historyList.appendChild(li);
    });
  }
  historyCount.textContent=winnerHistory.length;
}

/* ===== Force Lock POPUP ===== */
function openForceLockPopup(){
  const w = 620, h = 720;
  const y = Math.max(0, (window.outerHeight - h)/2 + window.screenY);
  const x = Math.max(0, (window.outerWidth  - w)/2 + window.screenX);
  const features = `width=${w},height=${h},left=${x},top=${y},resizable=yes,scrollbars=yes`;

  const win = window.open('', 'ForceLockWinners', features);
  if (!win || win.closed){ alert('‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Force Lock'); return; }

  const html = `<!DOCTYPE html>
  <html lang="th"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Force Lock Winners</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{font-family:Prompt,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7f9;color:#111827;letter-spacing:.2px}
    header{position:sticky;top:0;background:#fff;padding:14px 18px;border-bottom:1px solid #e5e7eb}
    main{padding:16px 18px}
    .row{display:flex;align-items:center;gap:10px;margin:10px 0}
    input[type=checkbox]{transform:scale(1.2)}
    textarea{width:100%;min-height:300px;padding:12px;border:1px solid #e5e7eb;border-radius:12px;box-sizing:border-box;font:inherit;background:#fff}
    small{color:#6b7280}
    .actions{display:flex;gap:10px;margin-top:14px}
    button{flex:1 1 auto;padding:12px 14px;border:none;border-radius:12px;color:#fff;font-weight:800;cursor:pointer}
    .save{background:#10b981}.close{background:#334155}
    .pill{display:inline-block;background:#e5e7eb;color:#111827;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.9rem;margin-left:8px}
  </style></head>
  <body>
    <header><h2 style="margin:0;font-weight:800">Force Lock Winners <span id="status" class="pill">OFF</span></h2></header>
    <main>
      <label class="row"><input id="enable" type="checkbox"/> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Force Lock Winners</label>
      <small>‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡πä‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏î <strong>Save</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡πá‡∏≠‡∏Ñ‡∏ú‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° <strong>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</strong> (‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ö‡∏ô‡∏•‡∏á‡∏•‡πà‡∏≤‡∏á)</small>
      <div class="row" style="margin-top:12px;align-items:flex-start;flex-direction:column">
        <label style="font-weight:800">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Ñ‡∏ú‡∏• (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <code>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏° | ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</code>)</label>
        <textarea id="locked" placeholder="‡πÄ‡∏ä‡πà‡∏ô:\n‡∏™‡∏°‡∏ä‡∏≤‡∏¢ | ‡∏ï‡∏∏‡πä‡∏Å‡∏ï‡∏≤ A\n‡∏°‡∏≤‡∏•‡∏µ | Gift Box B"></textarea>
        <small>‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà</small>
      </div>
      <div class="actions"><button class="save" id="saveBtn">Save</button><button class="close" id="closeBtn">Close</button></div>
    <script>
      const statusEl=document.getElementById('status'), enable=document.getElementById('enable'), locked=document.getElementById('locked');
      function sync(){
        try{
          const on=(window.opener&&!window.opener.closed&&window.opener.localStorage.getItem('pickerForceLockMode')==='1');
          const txt=(window.opener&&!window.opener.closed&&window.opener.localStorage.getItem('pickerLockedResults'))||'';
          enable.checked=!!on; locked.value=txt; statusEl.textContent=on?'ON':'OFF';
          statusEl.style.background=on?'#bbf7d0':'#e5e7eb'; statusEl.style.color=on?'#166534':'#111827';
        }catch(e){}
      }
      document.getElementById('saveBtn').addEventListener('click',function(){
        if(window.opener&&!window.opener.closed&&typeof window.opener.applyForceLockSettings==='function'){
          window.opener.applyForceLockSettings(locked.value, enable.checked); sync();
        }else{ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'); }
      });
      document.getElementById('closeBtn').addEventListener('click',()=>window.close());
      window.addEventListener('storage', sync); sync();
    <\/script></body></html>`;
  win.document.open(); win.document.write(html); win.document.close();
}

/* ===== UI open/close ===== */
settingsButton.addEventListener('click', (e)=>{ e.stopPropagation(); settingsModal.style.display='flex'; });
document.querySelectorAll('.close-button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const type=btn.getAttribute('data-close');
    if(type==='settings') settingsModal.style.display='none';
    if(type==='list')     listModal.style.display='none';
  });
});
window.addEventListener('click', (e)=>{
  if (e.target===settingsModal) settingsModal.style.display='none';
  if (e.target===listModal)     listModal.style.display='none';
});
listToggleButton.addEventListener('click', e=>{ e.stopPropagation(); listModal.style.display='flex'; });
// **NEW EVENT**: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Setting ‡πÉ‡∏ô List Modal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
listSettingIcon.addEventListener('click', e=>{
    e.stopPropagation(); 
    listModal.style.display='none';
    settingsModal.style.display='flex';
});


/* Buttons & shortcuts */
pickButton.addEventListener('click', spinSlot);
fullscreenButton.addEventListener('click', ()=>{ if(!document.fullscreenElement){ viewport.requestFullscreen?.(); } else{ document.exitFullscreen?.(); } });
showHistoryButton.addEventListener('click', ()=>{ historyPanel.style.display = historyPanel.style.display==='none' ? 'block':'none'; });
clearHistoryButton.addEventListener('click', ()=>{ if(!confirm('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return; winnerHistory=[]; localStorage.setItem('pickerWinnerHistory','[]'); renderHistory(); });
forceLockButton.addEventListener('click', openForceLockPopup);

/* Reset names */
resetButton.addEventListener('click', () => {
  if (!initialNameSnapshot) return;
  if (!confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  nameListTextarea.value = initialNameSnapshot;
  parseNameList(true);
  viewport.focus();
});

nameListTextarea.addEventListener('input', ()=>parseNameList(true));
allowRepeatsCheckbox.addEventListener('change', ()=>{ allowRepeats=allowRepeatsCheckbox.checked; localStorage.setItem('pickerAllowRepeats', allowRepeats?'1':'0'); });

/* Keyboard shortcuts - MODIFIED: ‡πÄ‡∏û‡∏¥‡πà‡∏° PageDown ‡πÅ‡∏•‡∏∞ ArrowRight ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Next ‡∏Ç‡∏≠‡∏á Pointer */
document.addEventListener('keydown',(e)=>{
  // **NEW**: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Ctrl/Cmd + A (Select All)
  if((e.key==='a' || e.key==='A') && (e.ctrlKey || e.metaKey)){
    e.preventDefault();
    return;
  }
  
  if((settingsModal.style.display!=='flex') && (listModal.style.display!=='flex') && !nameListTextarea.matches(':focus')){
    
    // --- ‡∏™‡∏∏‡πà‡∏° (Spin) ‡∏î‡πâ‡∏ß‡∏¢ Space / PageUp / PageDown / ArrowRight (‡∏õ‡∏∏‡πà‡∏° Next ‡∏Ç‡∏≠‡∏á Pointer) ---
    if((e.key===' ' || e.key==='PageUp' || e.key==='PageDown' || e.key==='ArrowRight') && !pickButton.disabled){
        e.preventDefault(); 
        spinSlot();
    }
    
    // **NEW**: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö / ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Welcome/Reset Display) ‡∏î‡πâ‡∏ß‡∏¢ r ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û
    else if(e.key==='r' || e.key==='R' || e.key==='‡∏û'){
        e.preventDefault();
        updateSlotRoll(null, 15, true);
    }
    
    // --- ‡∏™‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Next BG) ‡∏î‡πâ‡∏ß‡∏¢ x ‡∏´‡∏£‡∏∑‡∏≠ ‡∏õ ---
    else if(e.key==='x' || e.key==='X' || e.key==='‡∏õ'){e.preventDefault(); nextBackgroundImage();}

    // --- ‡∏™‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (Previous BG) ‡∏î‡πâ‡∏ß‡∏¢ z ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ú ---
    else if(e.key==='z' || e.key==='Z' || e.key==='‡∏ú'){
      e.preventDefault();
      prevBackgroundImage(); 
    }
    
    // --- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
    else if(e.key==='s' || e.key==='S'){e.preventDefault(); settingsModal.style.display='flex';}
    else if(e.key==='l' || e.key==='L'){e.preventDefault(); listModal.style.display = (listModal.style.display==='flex' ? 'none' : 'flex');}
    else if(e.key==='f' || e.key==='F'){e.preventDefault(); openForceLockPopup();}
  }
});
/* END Keyboard shortcuts - MODIFIED */

// **NEW**: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏Å (Drag Start) ‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
document.addEventListener('dragstart', function(e) {
    // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Gallery Thumbnail ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Drag & Drop ‡πÄ‡∏≠‡∏á
    if (!e.target.closest('#thumbnailGallery')) {
        e.preventDefault();
    }
});


slotTextColorInput.addEventListener('input',()=>{const c=slotTextColorInput.value;document.documentElement.style.setProperty('--slot-text-color',c);slotTextColorDisplay.textContent=c.toUpperCase();});
buttonTextColorInput.addEventListener('input',()=>{const c=buttonTextColorInput.value;document.documentElement.style.setProperty('--button-text-color',c);buttonTextColorDisplay.textContent=c.toUpperCase();});
slotBackgroundColorInput.addEventListener('input',()=>{const c=slotBackgroundColorInput.value;document.documentElement.style.setProperty('--slot-background-color',c);slotBackgroundColorDisplay.textContent=c.toUpperCase();});
bgColorInput.addEventListener('input',()=>{const c=bgColorInput.value;document.documentElement.style.setProperty('--background-color',c);bgColorDisplay.textContent=c.toUpperCase();});
buttonColorInput.addEventListener('input',()=>{const c=buttonColorInput.value;document.documentElement.style.setProperty('--button-color',c);buttonColorDisplay.textContent=c.toUpperCase();});
saveSettingsButton.addEventListener('click', saveSettings);
clearAllSettingsButton.addEventListener('click', clearAllSettings);
spinDurationInput.addEventListener('change',()=>{const t=parseInt(spinDurationInput.value); if(!isNaN(t)&&t>=1&&t<=10){spinTimeInSeconds=t;currentSpinDurationMS=t*1000;} else{spinTimeInSeconds=3;currentSpinDurationMS=3000;spinDurationInput.value=3;} localStorage.setItem('pickerSpinDuration', spinTimeInSeconds);});
alignmentControls.querySelectorAll('button').forEach(b=> b.addEventListener('click',()=>{document.documentElement.style.setProperty('--container-vertical-alignment', b.getAttribute('data-align')); localStorage.setItem('pickerVerticalAlignment', b.getAttribute('data-align')); alignmentControls.querySelectorAll('button').forEach(btn=>btn.classList.toggle('active', btn.getAttribute('data-align')===b.getAttribute('data-align')));} ));
uploadBgButton.addEventListener('click',()=>{ if(backgroundImages.length>=MAX_BG_IMAGES){alert(`‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${MAX_BG_IMAGES} ‡∏†‡∏≤‡∏û`);return;} bgImageFileInput.click(); });
bgImageFileInput.addEventListener('change',async(e)=>{const files=Array.from(e.target.files); let toProcess=files.slice(0, MAX_BG_IMAGES-backgroundImages.length); if(toProcess.length===0 && files.length>0){alert(`‡∏Ñ‡∏£‡∏ö ${MAX_BG_IMAGES} ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß`);return;} toProcess.sort((a,b)=>a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'})); const read=(file)=>new Promise(res=>{const r=new FileReader(); r.onload=ev=>res(ev.target.result); r.readAsDataURL(file);}); try{ const urls=await Promise.all(toProcess.map(read)); backgroundImages.push(...urls); currentBgIndex=backgroundImages.length-1; applyBackgroundImage(); alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ${urls.length} ‡∏†‡∏≤‡∏û (‡∏£‡∏ß‡∏° ${backgroundImages.length}/${MAX_BG_IMAGES}) ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏ß‡∏£`);}catch(err){console.error(err);alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');} bgImageFileInput.value='';});
clearBgImageButton.addEventListener('click', clearBackgroundImage);

/* Container Opacity Controls */
function updateContainerOpacity(value){
  containerOpacity = Math.min(1.0, Math.max(0.0, parseFloat(value) || 0));
  const cssValue = containerOpacity.toFixed(2);
  document.documentElement.style.setProperty('--container-opacity', cssValue);
  containerOpacityInput.value = cssValue;
  containerOpacitySlider.value = cssValue;

  // ** ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡πÄ‡∏á‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠ Opacity ‡πÄ‡∏õ‡πá‡∏ô 0 **
  if (containerOpacity === 0) {
    document.documentElement.style.setProperty('--container-box-shadow', 'none');
    document.documentElement.style.setProperty('--container-border-radius', '0');
  } else {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Opacity ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0
    document.documentElement.style.setProperty('--container-box-shadow', '0 10px 30px rgba(0,0,0,.06)');
    document.documentElement.style.setProperty('--container-border-radius', '18px');
  }
  // ** ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç **
}
containerOpacitySlider.addEventListener('input', (e) => updateContainerOpacity(e.target.value));
containerOpacityInput.addEventListener('change', (e) => updateContainerOpacity(e.target.value));

/* ===== Initial Load ===== */
(function initialLoad(){
  const st=getComputedStyle(document.documentElement);
  const defaults={bg:st.getPropertyValue('--background-color').trim(), btn:st.getPropertyValue('--button-color').trim(), slotText:st.getPropertyValue('--slot-text-color').trim(), btnText:st.getPropertyValue('--button-text-color').trim(), slotBg:st.getPropertyValue('--slot-background-color').trim()};
  document.documentElement.style.setProperty('--background-color', localStorage.getItem('pickerBgColor')||defaults.bg);
  document.documentElement.style.setProperty('--button-color', localStorage.getItem('pickerButtonColor')||defaults.btn);
  document.documentElement.style.setProperty('--slot-text-color', localStorage.getItem('pickerSlotTextColor')||defaults.slotText);
  document.documentElement.style.setProperty('--button-text-color', localStorage.getItem('pickerButtonTextColor')||defaults.btnText);
  document.documentElement.style.setProperty('--slot-background-color', localStorage.getItem('pickerSlotBgColor')||defaults.slotBg);

  const savedOpacity = localStorage.getItem('pickerContainerOpacity');
  containerOpacity = Number.isFinite(+savedOpacity) ? +savedOpacity : 0.5;
  updateContainerOpacity(containerOpacity);

  const savedSpin=parseInt(localStorage.getItem('pickerSpinDuration')); if(!isNaN(savedSpin)&&savedSpin>=1&&savedSpin<=10){spinTimeInSeconds=savedSpin;currentSpinDurationMS=savedSpin*1000;}
  const savedAlign=localStorage.getItem('pickerVerticalAlignment')||'center'; document.documentElement.style.setProperty('--container-vertical-alignment', savedAlign); alignmentControls.querySelectorAll('button').forEach(btn=>btn.classList.toggle('active', btn.getAttribute('data-align')===savedAlign));

  const savedImages=localStorage.getItem('pickerBgImages'); const savedIndex=localStorage.getItem('pickerBgImageIndex');
  if(savedImages){try{ backgroundImages=JSON.parse(savedImages)||[]; currentBgIndex=Number.isFinite(+savedIndex)? +savedIndex : -1; applyBackgroundImage(); }catch{ localStorage.removeItem('pickerBgImages'); localStorage.removeItem('pickerBgImageIndex'); }} else { backgroundImages=[]; currentBgIndex=-1; document.documentElement.style.setProperty('--bg-image','none'); }

  const savedList=localStorage.getItem('pickerNameList'); if(savedList!==null) nameListTextarea.value=savedList;
  initialNameSnapshot = nameListTextarea.value;
  parseNameList(true);

  allowRepeats = localStorage.getItem('pickerAllowRepeats')==='1';
  allowRepeatsCheckbox.checked=allowRepeats;

  try{ winnerHistory=JSON.parse(localStorage.getItem('pickerWinnerHistory')||'[]'); }catch{ winnerHistory=[]; }
  renderHistory();

  parseLockedResults();
  syncFullscreenUI(); viewport.focus();
})();
</script>
</body>
</html>
